#!/bin/bash

# Default values
CN_SERVER="myrabbitmq-server"
CN_CLIENT="myrabbitmq-client"
DAYS=3650

# Parse options
while getopts ":s:c:d:" opt; do
  case $opt in
    s)
      CN_SERVER="$OPTARG"
      ;;
    c)
      CN_CLIENT="$OPTARG"
      ;;
    d)
      DAYS="$OPTARG"
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      exit 1
      ;;
  esac
done

# Update and install packages
sudo apt update
sudo apt install -y rabbitmq-server openssl

# Generate self-signed certificates
CERT_DIR=/etc/rabbitmq/tls
sudo mkdir -p $CERT_DIR
cd $CERT_DIR
sudo openssl genrsa -out ca_key.pem 2048
sudo openssl req -x509 -new -nodes -key ca_key.pem -days $DAYS -out ca_cert.pem -subj "/CN=$CN_SERVER"
sudo openssl genrsa -out server_key.pem 2048
sudo openssl req -new -key server_key.pem -out server.csr -subj "/CN=$CN_SERVER"
sudo openssl x509 -req -in server.csr -CA ca_cert.pem -CAkey ca_key.pem -CAcreateserial -out server_cert.pem -days $DAYS

# Generate client certificate
sudo openssl genrsa -out client_key.pem 2048
sudo openssl req -new -key client_key.pem -out client.csr -subj "/CN=$CN_CLIENT"
sudo openssl x509 -req -in client.csr -CA ca_cert.pem -CAkey ca_key.pem -CAcreateserial -out client_cert.pem -days $DAYS

# Set ownership and permissions
sudo chown -R rabbitmq:rabbitmq $CERT_DIR
sudo chmod 640 $CERT_DIR/*.pem

# Configure RabbitMQ to use TLS and require client certificates
sudo bash -c "cat > /etc/rabbitmq/rabbitmq.conf << EOL
listeners.ssl.default = 5671
ssl_options.cacertfile = $CERT_DIR/ca_cert.pem
ssl_options.certfile = $CERT_DIR/server_cert.pem
ssl_options.keyfile = $CERT_DIR/server_key.pem
ssl_options.verify = verify_peer
ssl_options.fail_if_no_peer_cert = true
EOL"

# Restart RabbitMQ
sudo systemctl restart rabbitmq-server

# Verify TLS configuration and client authentication
echo "Testing TLS configuration and client authentication:"
sudo openssl s_client -connect localhost:5671 -CAfile $CERT_DIR/ca_cert.pem -cert $CERT_DIR/client_cert.pem -key $CERT_DIR/client_key.pem
