#!/bin/bash

usage() {
  echo "Usage: $0 -i <instance_name(s)>"
  echo "  -i <instance_name(s)>: Specify one or more Koha instance names separated by commas or spaces."
  echo "  -h: Display this help message."
  exit 1
}

while getopts ":i:h" opt; do
  case $opt in
    i)
      instance_names=$OPTARG
      ;;
    h)
      usage
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      usage
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      usage
      ;;
  esac
done

if [ -z "$instance_names" ]; then
  echo "Error: Koha instance names not specified."
  usage
fi

# Split instance names based on both commas and spaces
IFS=', ' read -ra instances <<< "$instance_names"

# List of foreign keys to drop
foreign_keys=("tmp_holdsqueue_ibfk_1")

for instance_name in "${instances[@]}"; do
  # Connect to the Koha database and drop the foreign keys
  for key in "${foreign_keys[@]}"; do
    echo "Dropping foreign key $key for instance $instance_name..."
    # Check if the foreign key exists before attempting to drop it
    existing_key=$(koha-mysql $instance_name -e "SHOW CREATE TABLE tmp_holdsqueue" | grep "$key")
    if [ -z "$existing_key" ]; then
      echo "Foreign key $key does not exist. Skipping drop..."
    else
      koha-mysql $instance_name <<EOF
        ALTER TABLE tmp_holdsqueue DROP FOREIGN KEY $key;
EOF
      if [ $? -eq 0 ]; then
        echo "Foreign key $key dropped successfully."
      else
        echo "Error: Failed to drop foreign key $key. Continuing..."
      fi
    fi

    # Continue with the upgrade process
    apt upgrade -y

    # Re-add the foreign key
    echo "Re-adding foreign key $key for instance $instance_name..."
    koha-mysql $instance_name <<EOF
      ALTER TABLE tmp_holdsqueue
        ADD CONSTRAINT \`$key\` FOREIGN KEY (\`itemnumber\`) REFERENCES \`items\` (\`itemnumber\`) ON DELETE CASCADE ON UPDATE CASCADE;
EOF

    if [ $? -eq 0 ]; then
      echo "Foreign key $key re-added successfully."
    else
      echo "Error: Failed to re-add foreign key $key. Exiting..."
      exit 1
    fi
  done

  echo "Finished processing instance: $instance_name"
done

echo "Script completed successfully."
